/* 
 * @version 1.1
 * @copyright ConVista
 * @author Martin Pankraz
 *
 * @classdesc UI5 HIerarchy Selector Plugin for SAP Design Studio in m mode
 *
 *
 * This component makes use of the jQuery Plugin waituntilExists by buu700 under the MIT License
 */
var libPathTreeTable=sap.zen.createStaticSdkMimeUrl("com.convista.ui5treetable","res/js/");require.config({paths:{exist:"../"+libPathTreeTable+"jquery.waituntilexists"},rlArgs:"v=20140515"}),define(["exist","css!../js/css/myUI5TreeTable.css"],function(exist){jQuery.sap.require("sap.zen.commons.layout.AbsoluteLayout"),jQuery.sap.require("sap.ui.table.TreeTable"),sap.zen.commons.layout.AbsoluteLayout.extend("com.convista.ui5treetable.UI5HierarchySelector",{setData:function(value){return this._data=value,this},getData:function(value){return this._data},setMetadata:function(value){return this._metadata=value,this},getMetadata:function(){return this._metadata},metadata:{properties:{DTableTitle:{type:"string"},DDimensionKey:{type:"string"},DHierarchyKey:{type:"string"},DHierarchyText:{type:"string"},DCheckBoxSelection:{type:"string"},DCheckBoxSelectionExt:{type:"string"},DCheckBoxSelectionFull:{type:"string"},DCheckBoxSelectionMixed:{type:"string"},DFilterSelectionExt:{type:"string"},DTableExpandedInitially:{type:"boolean"},DVisibleRowCount:{type:"int"},DExpandAllLevel:{type:"int"},DExpandFirstLevel:{type:"boolean"},DVisibleRowCountMode:{type:"String"},DRowHeight:{type:"int"},DShowRowLines:{type:"boolean"},DHideKeyOnKeyTextDisplay:{type:"boolean"},DShowColumnHeader:{type:"boolean"},DExpandText:{type:"string"},DCollapseText:{type:"string"},DSelectedText:{type:"string"}}},initDesignStudio:function(){sap.m.CheckBox.extend("com.convista.TriStateCheckBox",{metadata:{properties:{state:{type:"int",defaultValue:0}}},onAfterRendering:function(){var $this=this.$();$this.find("div").removeClass("sapMCbMarkChecked"),$this.removeClass("triStateCheckBoxSelected"),$this.removeClass("triStateCheckBoxMixed"),1===this.getState()?$this.addClass("triStateCheckBoxSelected"):2===this.getState()&&$this.addClass("triStateCheckBoxMixed")},fireSelect:function(s){var v=s.selected?1:0;0===this.getState()&&1===v?v=1:1===this.getState()&&1===v&&(v=0),this.setState(v),this.fireEvent("select",{state:v})},renderer:{}});var that=this;this.sCurrentLocale=sap.ui.getCore().getConfiguration().getLanguage(),this.myBundle=jQuery.sap.resources({url:libPathTreeTable+"i18n/i18n.properties",locale:this.sCurrentLocale}),this.addStyleClass("myUI5Table-auto-size"),this.tableContentHidden=!0,this.tableContentCreated=!1,this._hierarchy=null,this._hierarchy_selection=[],this._hierarchy_selection_ext=[],this._hierarchy_filter_ext=[],this._hierarchy_selection_full_key=[],this._hierarchy_mixed=[],this._selectionCounter=0,this._expandLevel=1,this._longestText="",this._counterLabel=new sap.m.Label({text:"0 selected",tooltip:this.myBundle.getText("counterLabel"),textAlign:"Right"}).addStyleClass("treeTableLabelM"),this._uncollapseAllBtn=new sap.m.Button({type:sap.m.ButtonType.Transparent,icon:"sap-icon://process",tooltip:this.myBundle.getText("expandAllButtonTooltip"),lite:!0,visible:!1,press:function(){0<that._expandLevel&&that._table.expandToLevel(that._expandLevel)}}).addStyleClass("treeTableButtonRightM"),this._collapseButton=new sap.m.Button({type:sap.m.ButtonType.Transparent,text:"uncollapse",tooltip:this.myBundle.getText("collapseButtonTooltip"),icon:"sap-icon://slim-arrow-down",press:function(){that._table.getVisible()?(that._table.setVisible(!1),that._table.removeStyleClass("convistaTreeTableExpanded"),this.setText(that.getDExpandText()),that._uncollapseAllBtn.setVisible(!1)):(that._table.setVisible(!0),that._table.addStyleClass("convistaTreeTableExpanded"),this.setText(that.getDCollapseText()),that._uncollapseAllBtn.setVisible(!0))}}).addStyleClass("convistaCollapseButtonM"),this._table=new sap.ui.table.TreeTable(this.getId()+"_trta",{visibleRowCount:12,rowHeight:22,firstVisibleRow:1,selectionMode:sap.ui.table.SelectionMode.None,expandFirstLevel:!0,allowColumnReordering:!1,showOverlay:!1,visible:!1}).addStyleClass("convistaTreeTable convistaTreeTableCollapsed"),this.clickHandlerActive=!1,this.attachBrowserEvent("focusin",function(oEvent){that.clickHandlerActive||that.getDTableExpandedInitially()||($(document).on("click",function(e){var target=e.target,container=$("#"+that.getId()+"_trta"),uncollapseAllBtnId=that._uncollapseAllBtn.getId(),collapseBtnId=that._collapseButton.getId();if(-1!==e.target.id.indexOf(uncollapseAllBtnId)||-1!==e.target.id.indexOf(collapseBtnId))return $(document).off("click"),void(that.clickHandlerActive=!1);container.is(target)||0!==container.has(target).length||(that._table.setVisible(!1),that._table.removeStyleClass("convistaTreeTableExpanded"),that._uncollapseAllBtn.setVisible(!1),that._collapseButton.setText(that.getDExpandText()),that.fireDesignStudioEvent("onFocusOut"),$(document).off("click"),that.clickHandlerActive=!1)}),that.clickHandlerActive=!0)}),this._oModel=new sap.ui.model.json.JSONModel,sap.ui.getCore().setModel(this._oModel),this._table.setModel(this._oModel),this._toolbar=new sap.m.Toolbar({height:"26px",content:[new sap.ui.layout.HorizontalLayout({width:"100%",content:[this._collapseButton,this._counterLabel,this._uncollapseAllBtn]})]}).addStyleClass("convistaTreeToolbar"),this.addContent(this._toolbar,{left:"0px",top:"0px"}),this.addContent(this._table,{left:"0px",top:"26px"}),this.layoutInitialized=!1,this.reloadRequested=!0,this._table.attachCellClick(this.onCellClick),this._table.attachRowSelectionChange(this.onRowClick),this._table.attachToggleOpenState(this.onToggleClick)},renderer:{},onAfterRendering:function(){var ctx=document.createElement("canvas").getContext("2d");ctx.font="11px Arial";var width=Math.ceil(ctx.measureText(this._longestText).width)+100,componentWidth=$("#"+this.getId()).width();width<componentWidth&&(width=componentWidth-2),this.oColumn.setWidth(width+"px")},afterDesignStudioUpdate:function(){var that=this;if(!this.layoutInitialized){this._counterLabel.setText("0 "+this.getDSelectedText()),this._collapseButton.setText(this.getDExpandText()),this._table.setColumnHeaderVisible(this.getDShowColumnHeader()),this.getDTableExpandedInitially()&&(this._table.setVisible(!0),this._uncollapseAllBtn.setVisible(!0),this._table.addStyleClass("convistaTreeTableExpanded")),this._table.setVisibleRowCount(this.getDVisibleRowCount()),"Auto"===this.getDVisibleRowCountMode()?this._table.setVisibleRowCountMode(sap.ui.table.VisibleRowCountMode.Auto):"Fixed"===this.getDVisibleRowCountMode()?this._table.setVisibleRowCountMode(sap.ui.table.VisibleRowCountMode.Fixed):this._table.setVisibleRowCountMode(sap.ui.table.VisibleRowCountMode.Interactive),this._table.setRowHeight(this.getDRowHeight()),this._table.setExpandFirstLevel(!1),this.getDShowRowLines()||this._table.addStyleClass("treeTableNoRowLines"),this._expandLevel=this.getDExpandAllLevel(),this.layoutInitialized=!0;var dimText="Hierarchy",_data=this.getData();if(void 0!==_data.dimensions)for(var i=0;i<_data.dimensions.length;i++)_data.dimensions[i].key===this.getDDimensionKey()&&(dimText=_data.dimensions[i].text);this.oColumn=new sap.ui.table.Column({resizable:!1,flexible:!1,autoResizable:!1,label:new sap.m.Label({text:dimText,design:sap.m.LabelDesign.Bold}),template:new com.convista.TriStateCheckBox({text:"{text}",state:"{checked}",select:function(e){that.onCheckBoxChange(e)}}).addStyleClass("myTriCb")}),this._table.addColumn(this.oColumn);var data={root:{children:this.flattenFormattedData()}};this._oModel.setData(data),this._table.setModel(this._oModel),this._table.bindRows("/root"),this.tableContentCreated=!0}},onCellClick:function(oEvent){},onRowClick:function(oEvent){},onToggleClick:function(oEvent){},onCheckBoxChange:function(oEvent){var me=oEvent.getSource(),state=me.getState(),path=(me.getBindingContext(),me.getBindingContext().getPath()),obj=this._table.getModel().getProperty(path);1===state?this.addHierarchySelection(obj):0===state&&this.removeHierarchySelection(obj),this.updateStateOfChildren(obj,path,state),void 0!==obj.level&&this.updateStateOfParent(path,state);var keysBexReady="",keysBexReadyExt="",keysFullBexReady="",mixedSelction="",filterExtBexReady="";0<this._hierarchy_selection.length&&(keysBexReady=JSON.stringify(this._hierarchy_selection),keysBexReadyExt=JSON.stringify(this._hierarchy_selection_ext),keysFullBexReady=JSON.stringify(this._hierarchy_selection_full_key),filterExtBexReady=JSON.stringify(this._hierarchy_filter_ext),keysBexReady=keysBexReady.substring(2,keysBexReady.length-2),keysBexReadyExt=keysBexReadyExt.substring(2,keysBexReadyExt.length-2),keysFullBexReady=keysFullBexReady.substring(2,keysFullBexReady.length-2),filterExtBexReady=filterExtBexReady.substring(2,filterExtBexReady.length-2),keysBexReady=this.replaceAll(keysBexReady,",",";"),keysBexReadyExt=this.replaceAll(keysBexReadyExt,",",";"),keysFullBexReady=this.replaceAll(keysFullBexReady,",",";"),filterExtBexReady=this.replaceAll(filterExtBexReady,",",";"),keysBexReady=this.replaceAll(keysBexReady,'"',""),keysBexReadyExt=this.replaceAll(keysBexReadyExt,'"',""),keysFullBexReady=this.replaceAll(keysFullBexReady,'"',""),filterExtBexReady=this.replaceAll(filterExtBexReady,'"',""),mixedSelction=(mixedSelction=JSON.stringify(this._hierarchy_mixed)).substring(2,mixedSelction.length-2),mixedSelction=this.replaceAll(mixedSelction,",",";"),mixedSelction=this.replaceAll(mixedSelction,'"',"")),this.setDCheckBoxSelection(keysBexReady),this.setDCheckBoxSelectionExt(keysBexReadyExt),this.setDCheckBoxSelectionFull(keysFullBexReady),this.setDCheckBoxSelectionMixed(mixedSelction),this.setDFilterSelectionExt(filterExtBexReady),this.fireDesignStudioPropertiesChanged(["DCheckBoxSelection","DCheckBoxSelectionExt","DFilterSelectionExt","DCheckBoxSelectionFull","DCheckBoxSelectionMixed"]),this.fireDesignStudioEvent("onCheckBoxSelected")},updateStateOfChildren:function(obj,parentPath,state){if("HIERARCHY_NODE"===obj.type)for(var pathToChildren=parentPath+"/children",obj_children=this._table.getModel().getProperty(pathToChildren),i=0;i<obj_children.length;i++){var child=obj_children[i];1===(child.checked=state)?this.addHierarchySelection(child):0===state?this.removeHierarchySelection(child):2===state&&this.removeHierarchySelection(child),0<child.children.length&&this.updateStateOfChildren(child,pathToChildren+"/"+i,child.checked)}},updateStateOfParent:function(currentPath,state){var countChecked=0,countMixed=0,newState=0,parentPath=currentPath.substring(0,currentPath.lastIndexOf("/children")),parentObj=this._table.getModel().getProperty(parentPath);this.removeHierarchySelection(parentObj);var numberOfChildren=parentObj.children.length;if(0<numberOfChildren){for(var i=0;i<numberOfChildren;i++){var child=parentObj.children[i];1===child.checked?countChecked++:2===child.checked&&countMixed++}0===countChecked?(newState=0,this.removeMixedSelection(parentObj)):countChecked<numberOfChildren&&(newState=2,this.addMixedSelection(parentObj)),0!==countMixed&&(newState=2,this.addMixedSelection(parentObj)),parentObj.checked=newState,void 0!==parentObj.level&&this.updateStateOfParent(parentPath,newState)}else parentObj.children.checked=state},addHierarchySelection:function(obj){var compareKey=null,compareKeyExt=null,compareKeyFull=null;void 0!==obj.key?(compareKey=obj.key.substring(obj.key.lastIndexOf("/")+1),compareKeyExt=this.extractFromKeyText(obj.text,compareKey),compareKeyFull=obj.key):(compareKey=obj.children.key.substring(obj.children.key.lastIndexOf("/")+1),compareKeyExt=this.extractFromKeyText(obj.children.text,compareKey),compareKeyFull=obj.children.key),-1===$.inArray(compareKey,this._hierarchy_selection)&&(this._hierarchy_selection.push(compareKey),this._hierarchy_selection_ext.push(compareKeyExt),this._hierarchy_selection_full_key.push(compareKeyFull),this._hierarchy_filter_ext.push(obj.filterExtValue),this._selectionCounter++,this._counterLabel.setText(this._selectionCounter+" "+this.getDSelectedText()))},removeHierarchySelection:function(obj){var compareKey=null;compareKey=void 0!==obj.key?obj.key.substring(obj.key.lastIndexOf("/")+1):obj.children.key.substring(obj.children.key.lastIndexOf("/")+1);var idx=$.inArray(compareKey,this._hierarchy_selection);-1!==idx&&(this._hierarchy_selection.splice(idx,1),this._hierarchy_selection_ext.splice(idx,1),this._hierarchy_selection_full_key.splice(idx,1),this._hierarchy_filter_ext.splice(idx,1),this._selectionCounter--,this._counterLabel.setText(this._selectionCounter+" "+this.getDSelectedText()))},addMixedSelection:function(obj){var compareKey=null;void 0!==obj.key?(compareKey=obj.key.substring(obj.key.lastIndexOf("/")+1),obj.key):(compareKey=obj.children.key.substring(obj.children.key.lastIndexOf("/")+1),obj.children.key),-1===$.inArray(compareKey,this._hierarchy_mixed)&&this._hierarchy_mixed.push(compareKey)},removeMixedSelection:function(obj){var compareKey=null;compareKey=void 0!==obj.key?obj.key.substring(obj.key.lastIndexOf("/")+1):obj.children.key.substring(obj.children.key.lastIndexOf("/")+1);var idx=$.inArray(compareKey,this._hierarchy_mixed);-1!==idx&&this._hierarchy_mixed.splice(idx,1)},flattenFormattedData:function(){if(void 0!==sap.zen.designmode)return this.getExampleData();var _data=this.getData();if(void 0!==_data.dimensions)for(var i=0;i<_data.dimensions.length;i++)if(_data.dimensions[i].key===this.getDDimensionKey()){var members=_data.dimensions[i].members;if(0<members.length){var hier=_data.dimensions[i].hierarchy;if(hier){if(this.setDHierarchyKey(hier.key),this.setDHierarchyText(hier.text),this.fireDesignStudioPropertiesChanged(["DHierarchyKey","DHierarchyText"]),this._hierarchy=members[0],this.getDHideKeyOnKeyTextDisplay())this._hierarchy.text=this.extractFromKeyText(members[0].text,members[0].key);else{var combined=members[0].text+members[0].key;this._longestText.length<combined.length&&(this._longestText=combined)}if("HIERARCHY_NODE"===this._hierarchy.type){var hier_characteristic=this._hierarchy.key.split("/")[1],shortKey=this._hierarchy.key.substring(this._hierarchy.key.lastIndexOf("/")+1);this._hierarchy.filterExtValue="0HIER_NODE"===hier_characteristic?"+"+shortKey+"(Text Node)":"+"+shortKey+"("+hier_characteristic+")"}else this._hierarchy.filterExtValue=this._hierarchy.key.substring(this._hierarchy.key.lastIndexOf("/")+1);this._hierarchy.children=[];var wasChecked=this.entryWasChecked(members[0].key);return 0===wasChecked?(this._hierarchy.checked=0,this.removeHierarchySelection(this._hierarchy)):1===wasChecked?(this._hierarchy.checked=1,this.addHierarchySelection(this._hierarchy)):2===wasChecked&&(this._hierarchy.checked=2,this.addMixedSelection(this._hierarchy)),this.resolveHierarchy(members.slice(1),this._hierarchy.children,members[0].key),this._hierarchy}return window.console&&console.log("DataSource contains no hierarchy for given dimension "+this.getDDimensionKey()),[]}}return[]},resolveHierarchy:function(data,parentChildren,parentKey){for(var i=0;i<data.length;i++){var entry=data[i],wasChecked=this.entryWasChecked(entry.key);if(0===wasChecked?(entry.checked=0,this.removeHierarchySelection(entry)):1===wasChecked?(entry.checked=1,this.addHierarchySelection(entry)):2===wasChecked&&(entry.checked=2,this.addMixedSelection(entry)),this.getDHideKeyOnKeyTextDisplay()&&(entry.text=this.extractFromKeyText(entry.text,entry.key)),"HIERARCHY_NODE"===entry.type){var hier_characteristic=entry.key.split("/")[1],shortKey=entry.key.substring(entry.key.lastIndexOf("/")+1);entry.filterExtValue="0HIER_NODE"===hier_characteristic?"+"+shortKey+"(Text Node)":"+"+shortKey+"("+hier_characteristic+")"}else entry.filterExtValue=entry.key;entry.parent===parentKey&&(entry.children=[],parentChildren.push(entry),void 0!==entry.type&&this.resolveHierarchy(data.slice(1),entry.children,entry.key))}},entryWasChecked:function(entry){var result=0,formerSelection=this.getDCheckBoxSelection();formerSelection=formerSelection.split(";");var compareKey=entry.substring(entry.lastIndexOf("/")+1);if(-1===$.inArray(compareKey,formerSelection)){var formerMixedSelection=this.getDCheckBoxSelectionMixed();formerMixedSelection=formerMixedSelection.split(";"),result=-1===$.inArray(compareKey,formerMixedSelection)?0:2}else result=1;return result},extractFromKeyText:function(text,internalKey){var result=text;internalKey=internalKey.substring(internalKey.lastIndexOf("/")+1);for(var parts=text.split("|"),i=0;i<parts.length;i++){if(-1===parts[i].replace("/","").indexOf(internalKey)){result=parts[i];break}}var combined=text+internalKey;return this._longestText.length<combined.length&&(this._longestText=combined),result},getExampleData:function(){return{text:"root",description:"root description",checked:0,children:[{text:"item1",description:"item1 description",checked:1,children:[{text:"subitem1-1",description:"subitem1-1 description",checked:2,children:[{text:"subsubitem1-1-1",description:"subsubitem1-1-1 description",checked:0},{text:"subsubitem1-1-2",description:"subsubitem1-1-2 description",checked:1}]},{text:"subitem1-2",description:"subitem1-2 description",checked:1,children:[{text:"subsubitem1-2-1",description:"subsubitem1-2-1 description",checked:1}]}]},{text:"item2",description:"item2 description",checked:1,children:[{text:"subitem2-1",description:"subitem2-1 description",checked:1}]},{text:"item3",description:"item3 description",checked:1}]}},compareIntegers:function(value1,value2){return null!=value1&&null!=value1&&""!=value1||null!=value2&&null!=value2&&""!=value2?null==value1||null==value1||""==value1?-1:null==value2||null==value2||""==value2?1:parseInt(value1)<parseInt(value2)?-1:parseInt(value1)==parseInt(value2)?0:parseInt(value1)>parseInt(value2)?1:void 0:0},compareFloats:function(value1,value2){return null!=value1&&null!=value1&&""!=value1||null!=value2&&null!=value2&&""!=value2?null==value1||null==value1||""==value1?-1:null==value2||null==value2||""==value2?1:parseFloat(value1)<parseFloat(value2)?-1:parseFloat(value1)==parseFloat(value2)?0:parseFloat(value1)>parseFloat(value2)?1:void 0:0},compareDates:function(value1,value2){return null!=value1&&null!=value1&&""!=value1||null!=value2&&null!=value2&&""!=value2?null==value1||null==value1||""==value1?-1:null==value2||null==value2||""==value2?1:(value1=this.parseDateString(value1))<(value2=this.parseDateString(value2))?-1:value2<value1?1:0:0},compareText:function(value1,value2){return value1.toLowerCase(),value2.toLowerCase(),value1.localeCompare(value2)},isInteger:function(value){return/^\d+|"\d+"$/.test(value)},isFloat:function(value){return/^\d+\.\d+|"\d+\.\d+"$/.test(value)},isDate:function(value){return!!/^[0-9]{2}(\.|-|\/)[0-9]{2}(\.|-|\/)[0-9]{4}(\s*[0-9]{2}:[0-9]{2}:[0-9]{2})?(\s(AM|PM))?$/.test(value)},parseDateString:function(value){var splitter=null,year="",month="",day="",time="",hasTime=!1,parts="";return-1!==value.indexOf(":")&&(hasTime=!0),-1!==value.indexOf("/")?(splitter="/",year=(parts=value.split(splitter))[2],hasTime&&(time=(year=parts[2].replace(/\s{2,}/g," ").split(" "))[1].split(":"),year=year[0]),month=parts[0]-1,day=parts[1]):-1!==value.indexOf(".")?(splitter=".",year=(parts=value.split(splitter))[2],hasTime&&(time=(year=parts[2].replace(/\s{2,}/g," ").split(" "))[1].split(":"),year=year[0]),month=parts[1]-1,day=parts[0]):-1!==value.indexOf("-")?(splitter="-",year=(parts=value.split(splitter))[2],hasTime&&(time=(year=parts[2].replace(/\s{2,}/g," ").split(" "))[1].split(":"),year=year[0]),month=parts[0]-1,day=parts[1]):window.console&&console.log("parseDateString: not a date! "+value),hasTime?("PM"!==value.slice(-2)&&"pm"!==value.slice(-2)||(time[0]=parseInt(time[0])+12),new Date(year,month,day,time[0],time[1],time[2])):new Date(year,month,day)},checkIE:function(){var ms_ie=!1,ua=window.navigator.userAgent,old_ie=ua.indexOf("MSIE "),new_ie=ua.indexOf("Trident/");return(-1<old_ie||-1<new_ie)&&(ms_ie=!0),ms_ie},checkFF:function(){return-1<navigator.userAgent.toLowerCase().indexOf("firefox")},replaceAll:function(string,find,replace){return string.replace(new RegExp(this.escapeRegExp(find),"g"),replace)},escapeRegExp:function(string){return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")}})});