!function(){var scriptSrc=$("script:last").attr("src");sap.designstudio.sdk.Component.subclass("com.convista.maps.DataMap",function(){function initMap(callback){window.initializeGmaps=function(){BASE_URL&&($("head").append('<script type="text/javascript" src="'+BASE_URL+MARKERLABEL_INCLUDE+'"></script>'),$("head").append('<script type="text/javascript" src="'+BASE_URL+MARKERCLUSTER_INCLUDE+'"></script>'),$("head").append('<script type="text/javascript" src="'+BASE_URL+OMS_INCLUDE+'"></script>')),that.geocoder=new google.maps.Geocoder;var mapOptions={center:new google.maps.LatLng(DEFAULT_LATITUDE,DEFAULT_LONGITUDE),zoom:8,panControl:!0,zoomControl:!0,mapTypeControl:!0,scaleControl:!0,streetViewControl:!0,overviewMapControl:!0,mapTypeId:google.maps.MapTypeId.ROADMAP};that.map=new google.maps.Map(that.$()[0],mapOptions);var mapsLayerControllDiv=document.createElement("div");that.mapsLayerControl=new MapsLayerControl(mapsLayerControllDiv,that.map);var mapsKeyfigureControllDiv=document.createElement("div");that.mapsKeyfigureDisplayControl=new MapsKeyfigureDisplayControl(mapsKeyfigureControllDiv,that.map);var mapsMarkerDisplayControlDiv=document.createElement("div");that.mapsMarkerDisplayControl=new MapsMarkerDisplayControl(mapsMarkerDisplayControlDiv,that.map),mapsLayerControllDiv.index=1,that.map.controls[google.maps.ControlPosition.LEFT_TOP].push(mapsLayerControllDiv),mapsKeyfigureControllDiv.index=1,that.map.controls[google.maps.ControlPosition.RIGHT_TOP].push(mapsKeyfigureControllDiv),mapsMarkerDisplayControlDiv.index=1,that.map.controls[google.maps.ControlPosition.TOP_CENTER].push(mapsMarkerDisplayControlDiv);var mcOptions={gridSize:50,maxZoom:15,ignoreHidden:!0,imagePath:IMAGE_URL};that.markerClusterer=new MarkerClusterer(that.map,[],mcOptions),that.markerClusterer.setZoomOnClick(!1),that.markerClusterer.setCalculator(myCalculator),google.maps.event.addListener(that.markerClusterer,"click",function(cluster){myClusterClick(cluster)}),that.trafficLayer=new google.maps.TrafficLayer,that.weatherLayer=new google.maps.weather.WeatherLayer({temperatureUnits:google.maps.weather.TemperatureUnit.CELSIUS}),that.cloudLayer=new google.maps.weather.CloudLayer,that.oms=new OverlappingMarkerSpiderfier(that.map);var infowindow=new google.maps.InfoWindow;that.oms.addListener("click",function(marker){infowindow.setContent(marker.desc),infowindow.open(that.map,marker),that.address(marker.address),that.firePropertiesChanged(["address"]),that.fireEvent("onMarkerClicked")}),google.maps.event.addListenerOnce(that.map,"idle",function(){var c=that.map.getCenter(),z=that.map.getZoom();if(void 0!==typeof Storage&&void 0!==sessionStorage.map_center_stored&&void 0!==sessionStorage.map_zoom_stored){var lat=sessionStorage.lat,lng=sessionStorage.lng,zoom=parseInt(sessionStorage.map_zoom_stored);if(google.maps.event.trigger(that.map,"resize"),isFloat(lat)===!0&&isFloat(lng)===!0){var loc=new google.maps.LatLng(lat,long);that.map.setCenter(loc),that.map.setZoom(zoom)}}else google.maps.event.trigger(that.map,"resize"),that.map.setCenter(c),that.map.setZoom(z)}),google.maps.event.addListener(that.map,"center_changed",function(){if(void 0!==typeof Storage){var center=that.map.getCenter();sessionStorage.lat=center.lat(),sessionStorage.lng=center.lng(),sessionStorage.map_zoom_stored=that.map.getZoom()}else window.console&&console.log("Web browser storage type undefined. Please use a different one.")}),google.maps.event.addListener(that.map,"zoom_changed",function(){void 0!==typeof Storage?sessionStorage.map_zoom_stored=that.map.getZoom():window.console&&console.log("Web browser storage type undefined. Please use a different one.")}),callback()},saveApiLoad===!0?($(document).ready(function(){BASE_URL?$("head").append('<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key='+saveAPIKey+'&libraries=weather,drawing&sensor=false&callback=initializeGmaps"></script>'):window.console&&console.log("App Base URL not set correctly! Please contact App designer!")}),that.apiload(!1),that.firePropertiesChanged(["apiload"])):initializeGmaps()}function initData(){if(runtime_data){for(var dim=null,id=null,address=null,marker_text=null,date=null,keyfigure2_array=[],keyfigure2=0,keyfigure1_array=[],keyfigure1=0,keyfigure2_array_diff=[],keyfigure2_diff=0,keyfigure1_array_diff=[],keyfigure1_diff=0,iter_step=0,notif_position_in_dimensions_array=0,l=0;l<runtime_data.dimensions.length;l++)if(dim=runtime_data.dimensions[l],dim.containsMeasures===!0){iter_step=dim.members.length;for(var i=0;i<dim.members.length;i++)if(dim.members[i].text===saveKeyFigureName1){var format=parseNumberFormatString(dim.members[i].formatString);keyfigureFormatStrings.figure1=""===format?"0":format}else if(dim.members[i].text===saveKeyFigureName2){var format=parseNumberFormatString(dim.members[i].formatString);keyfigureFormatStrings.figure2=""===format?"0":format}}else dim.key===saveTextDimension&&(notif_position_in_dimensions_array=l);for(var tuples_grouped_by_rowKey=[],i=0,current_row_key_index=runtime_data.tuples[0][notif_position_in_dimensions_array],current_tuples_to_group=new Array;i<runtime_data.tuples.length;){var tuple=runtime_data.tuples[i];if(tuple[notif_position_in_dimensions_array]===current_row_key_index){var row=runtime_data.dimensions[1].members[tuple[1]].type;"RESULT"!==row&&current_tuples_to_group.push(tuple)}else tuples_grouped_by_rowKey.push(current_tuples_to_group),current_tuples_to_group=new Array,current_tuples_to_group.push(tuple),current_row_key_index=tuple[notif_position_in_dimensions_array];i===runtime_data.tuples.length-1&&tuples_grouped_by_rowKey.push(current_tuples_to_group),i++}for(var data_pointer=-iter_step,l=0;l<tuples_grouped_by_rowKey.length;l++){for(var i=0;i<tuples_grouped_by_rowKey[l].length;i+=iter_step){var tuple=tuples_grouped_by_rowKey[l][i];data_pointer+=iter_step;for(var j=0;j<tuple.length;j++)if(dim=runtime_data.dimensions[j],dim.key===saveAddressDimension)address=dim.members[tuple[j]].text;else if(dim.key===saveTextDimension)id=dim.members[tuple[j]].key,marker_text=dim.members[tuple[j]].text;else if(dim.key===saveDateDimension)date=dim.members[tuple[j]].text;else if(dim.containsMeasures===!0)for(var k=0;k<dim.members.length;k++){var index=data_pointer+k,data="";dim.members[k].text===saveKeyFigureName1?null===runtime_data.data[index]||""===runtime_data.data[index]?(data=isFloat(keyfigureFormatStrings.figure1)?parseFloat("0.00").toFixed(4):"0",keyfigure1_array.push(data)):keyfigure1_array.push(runtime_data.data[index]):dim.members[k].text===saveKeyFigureName2?null===runtime_data.data[index]||""===runtime_data.data[index]?(data=isFloat(keyfigureFormatStrings.figure2)?parseFloat("0.00").toFixed(4):"0",keyfigure2_array.push(data)):keyfigure2_array.push(runtime_data.data[index]):dim.members[k].text===saveKeyFigureName1Diff?null===runtime_data.data[index]||""===runtime_data.data[index]?(data=isFloat(keyfigureFormatStrings.figure1)?parseFloat("0.00").toFixed(4):"0",keyfigure1_array_diff.push(data)):keyfigure1_array_diff.push(runtime_data.data[index]):dim.members[k].text===saveKeyFigureName2Diff&&(null===runtime_data.data[index]||""===runtime_data.data[index]?(data=isFloat(keyfigureFormatStrings.figure2)?parseFloat("0.00").toFixed(4):"0",keyfigure2_array_diff.push(data)):keyfigure2_array_diff.push(runtime_data.data[index]))}}for(var m=0;m<keyfigure1_array.length;m++)isInt(keyfigureFormatStrings.figure1)?(keyfigure1+=parseInt(keyfigure1_array[m],10),keyfigure1_diff+=parseInt(keyfigure1_array_diff[m],10)):(keyfigure1+=parseFloat(keyfigure1_array[m]),keyfigure1_diff+=parseFloat(keyfigure1_array_diff[m])),isInt(keyfigureFormatStrings.figure2)?(keyfigure2+=parseInt(keyfigure2_array[m],10),keyfigure2_diff+=parseInt(keyfigure2_array_diff[m],10)):(keyfigure2+=parseFloat(keyfigure2_array[m]),keyfigure2_diff+=parseFloat(keyfigure2_array_diff[m]));if(!(address&&id&&marker_text&&date))return void alert("There is a dimension data read error. Probably you didn't specify all necessary dimensions. Please review settings in Design Studio.");var doc=findInAddressDatabase(address);if(null!==doc&&void 0!==doc){var loc=new google.maps.LatLng(doc.geometry.coordinates[0],doc.geometry.coordinates[1]);createMarker(address,[keyfigure1,keyfigure2,keyfigure1_diff,keyfigure2_diff],marker_text,loc,date,id)}else geocodeMarker(address,[keyfigure1,keyfigure2,keyfigure1_diff,keyfigure2_diff],marker_text,date,id);keyfigure1_array=[],keyfigure1_array_diff=[],keyfigure2_array=[],keyfigure2_array_diff=[],keyfigure1=0,keyfigure1_diff=0,keyfigure2=0,keyfigure2_diff=0}}}function hideMarkers(){for(var i=0;i<that.markerClusterer.markers_.length;i++)that.markerClusterer.markers_[i].setVisible(!1)}function showAllMarkers(){for(var i=0;i<that.markerClusterer.markers_.length;i++)that.markerClusterer.markers_[i].setVisible(!0)}function markClusterToShowById(id,keyfigureUpdated){for(var result=!1,markers=that.markerClusterer.markers_,i=0;i<markers.length;i++){var marker=markers[i];if(marker.id==id){isFloat(keyfigureUpdated[0])&&(keyfigureUpdated[0]=parseFloat(keyfigureUpdated[0]).toFixed(2)),isFloat(keyfigureUpdated[1])&&(keyfigureUpdated[1]=parseFloat(keyfigureUpdated[1]).toFixed(2)),marker.keyfigure1=keyfigureUpdated[0],marker.keyfigure2=keyfigureUpdated[1],marker.diff1=keyfigureUpdated[2],marker.diff2=keyfigureUpdated[3],marker.setVisible(!0),result=!0;break}}return result}function findInAddressDatabase(address){var result=null;if(address=address.toUpperCase(),ALL_ADDRESSES)for(var i=0;i<ALL_ADDRESSES.length;i++)if(ALL_ADDRESSES[i].properties.name.toUpperCase()===address){result=ALL_ADDRESSES[i];break}return result}function updateAddressDatabase(addressObject,location){var data={type:"Feature",geometry:{type:"Point",coordinates:[location.lat(),location.lng()]},properties:{name:addressObject}};if(null!==DB_URL&&void 0!==DB_URL&&""!==DB_URL)$.ajax({type:"POST",url:DB_URL,data:JSON.stringify(data),contentType:"application/json",error:function(e){window.console&&console.log(e.message)}});else{var addressObjectStore=DB.transaction(STORE_NAME,"readwrite").objectStore(STORE_NAME),request=addressObjectStore.add(data);request.onerror=function(){console.log("Wasn't able to complete adding address to db")}}}function geocodeMarker(addressObject,key_figure,text,date,id){setTimeout(function(){that.geocoder.geocode({address:addressObject},function(results,status){status==google.maps.GeocoderStatus.OK?(key_figure&&createMarker(addressObject,key_figure,text,results[0].geometry.location,date,id),updateAddressDatabase(addressObject,results[0].geometry.location)):window.console&&console.log("Geocode failed for the following reason: "+status+"\n"+addressObject)})},2e3*Math.random()*2e3)}function createMarker(address,key_figure_array,text,position,date,id){var figure=0;figure=that.keyfiguretodisplay()===saveKeyFigureName1?0:that.keyfiguretodisplay()===saveKeyFigureName2?1:0;var marker=new MarkerWithLabel({id:id,address:address,date:date,position:position,keyfigure1:key_figure_array[0],diff1:key_figure_array[2],keyfigure2:key_figure_array[1],diff2:key_figure_array[3],labelContent:key_figure_array[0],activeKeyfigure:figure,labelAnchor:new google.maps.Point(10,0),labelClass:"labels",labelInBackground:!1});return attachPopupDetailsToMarker(marker,text),that.markerClusterer.addMarker(marker,!1),that.oms.addMarker(marker),marker}function attachPopupDetailsToMarker(marker,detailsText){var content='<div class="map-info-window"><h1>Info</h1><p>'+detailsText+"</p></div>";marker.desc=content}function convertDateToInternalSAP(date_string){var date=date_string.split("."),dd=date[0],mm=date[1],yyyy=date[2];return yyyy+""+mm+dd}function parseNumberFormatString(keyfigureFormatString){var part_without_minus_operator=keyfigureFormatString.split(";")[0];return part_without_minus_operator.replace(new RegExp("#","g"),"0")}function myCalculator(markers){var index=0,title="Click marker to isolate on map view. Click button on top of the map to reset again.",count=0,count_diff=0,keyfigure_diff=0,step1=0,step2=0,step3=0,step4=0,format_string="",figure_format="";if(markers.length>0){if(0===markers[0].activeKeyfigure?figure_format=keyfigureFormatStrings.figure1:1===markers[0].activeKeyfigure&&(figure_format=keyfigureFormatStrings.figure2),isInt(figure_format))for(var i=0;i<markers.length;i++)0===markers[0].activeKeyfigure?(count+=parseInt(markers[i].keyfigure1,10),count_diff+=parseInt(markers[i].diff1,10)):1===markers[0].activeKeyfigure?(count+=parseInt(markers[i].keyfigure2,10),count_diff+=parseInt(markers[i].diff2,10)):window.console&&console.log("Active keyfigure 0 number not supported!");else if(isFloat(figure_format))for(var i=0;i<markers.length;i++)0===markers[0].activeKeyfigure?(count+=parseFloat(markers[i].keyfigure1),count_diff+=parseFloat(markers[i].diff1)):1===markers[0].activeKeyfigure?(count+=parseFloat(markers[i].keyfigure2),count_diff+=parseFloat(markers[i].diff2)):window.console&&console.log("Active keyfigure 1 number not supported!");else window.console&&console.log("Marker content to display not supported. Only use int or float!");0===markers[0].activeKeyfigure&&""!==saveKeyFigureName1ClusterSteps?(step1=saveKeyFigureName1ClusterSteps[0],step2=saveKeyFigureName1ClusterSteps[1],step3=saveKeyFigureName1ClusterSteps[2],step4=saveKeyFigureName1ClusterSteps[3]):1===markers[0].activeKeyfigure&&""!==saveKeyFigureName2ClusterSteps&&(step1=saveKeyFigureName2ClusterSteps[0],step2=saveKeyFigureName2ClusterSteps[1],step3=saveKeyFigureName2ClusterSteps[2],step4=saveKeyFigureName2ClusterSteps[3]),format_string="0 a"}return index=step1>=count?1:step2>=count?2:step3>=count?3:step4>=count?4:5,keyfigure_diff=(count-count_diff)/count,count=numeral(count).format(format_string),{text:count,index:index,title:title}}function isInt(value){var result=null,int_regex=/^-?[0-9]$/,int_regex_string=/^"-?[0-9]"$/;return result=int_regex.test(value)?!0:int_regex_string.test(value)?!0:!1}function isFloat(value){var result=null,float_regex=/^-?[0-9]+\.?[0-9]+\,?[0-9]+$/,float_regex_string=/^"-?[0-9]+\.?[0-9]+,[0-9]+"$/;return result=float_regex.test(value)?!0:float_regex_string.test(value)?!0:!1}function myClusterClick(cluster){var address=[],date=[],id=[];hideMarkers();for(var i=0;i<cluster.markers_.length;i++){var marker=cluster.markers_[i];address.push(marker.address),date.push(convertDateToInternalSAP(marker.date)),id.push(marker.id),marker.setVisible(!0)}var address_json='"'+saveAddressDimension+'": '+JSON.stringify(address),date_json='"'+saveDateDimension+'":'+JSON.stringify(date),id_json='"'+saveTextDimension+'":'+JSON.stringify(id),transport="{"+id_json+","+address_json+","+date_json+"}";that.clusterselection(transport),that.addressselection(address_json),that.dateselection(date_json),that.idselection(id_json),that.firePropertiesChanged(["clusterselection","addressselection","dateselection","idselection"]),that.fireEvent("onClusterClick"),that.markerClusterer.repaint()}function openAddressDatabase(callback){if(window.indexedDB){var openRequest=indexedDB.open(DB_NAME,1);openRequest.onerror=function(e){window.console&&(console.log("Error opening addresses db"),console.dir(e))},openRequest.onupgradeneeded=function(e){DB=e.target.result,DB.objectStoreNames.contains(STORE_NAME)||(console.log("create the addresses and settings objectstore"),OBJECT_STORE=DB.createObjectStore(STORE_NAME,{autoIncrement:!0}))},openRequest.onsuccess=function(e){DB=e.target.result,DB.onerror=function(event){alert("Database error: "+event.target.errorCode),window.console&&console.dir(event.target)},callback()}}else window.alert("Your browser doesn't support a stable version of IndexedDB. Such and such feature will not be available.")}function getAllItems(callback){var transactionType={READ_ONLY:"readonly",READ_WRITE:"readwrite"};IDBTransaction.READ_ONLY&&IDBTransaction.READ_WRITE&&(transactionType.READ_ONLY=IDBTransaction.READ_ONLY,transactionType.READ_WRITE=IDBTransaction.READ_WRITE);var trans=DB.transaction(STORE_NAME,transactionType.READ_ONLY),store=trans.objectStore(STORE_NAME),cursorRequest=store.openCursor();cursorRequest.onerror=function(error){window.console&&console.log(error)},cursorRequest.onsuccess=function(evt){var cursor=evt.target.result;cursor&&(ALL_ADDRESSES.push(cursor.value),eval("cursor.continue()"))},trans.oncomplete=function(){callback()}}function MapsKeyfigureDisplayControl(controlDiv){controlDiv.style.padding="5px";var controlUIKeyfigure=document.createElement("div");controlUIKeyfigure.style.backgroundColor="white",controlUIKeyfigure.style.borderColor="grey",controlUIKeyfigure.style.borderStyle="solid",controlUIKeyfigure.style.borderWidth="1px",controlUIKeyfigure.style.cursor="pointer",controlUIKeyfigure.style.textAlign="center",controlUIKeyfigure.title="Click to switch keyfigure to show on clusters",controlUIKeyfigure.figure1=!0,controlUIKeyfigure.figure2=!1,controlDiv.appendChild(controlUIKeyfigure);var controlTextKeyfigure=document.createElement("div");controlTextKeyfigure.style.fontFamily="Arial,sans-serif",controlTextKeyfigure.style.fontSize="10px",controlTextKeyfigure.style.fontWeight="normal",controlTextKeyfigure.style.color="black",controlTextKeyfigure.style.paddingTop="2px",controlTextKeyfigure.style.paddingLeft="5px",controlTextKeyfigure.style.paddingRight="5px",controlTextKeyfigure.style.paddingBottom="2px",controlTextKeyfigure.innerHTML="<b>1</b>",that.keyfiguretodisplay()===saveKeyFigureName1?controlTextKeyfigure.innerHTML="<b>-1-</b>":that.keyfiguretodisplay()===saveKeyFigureName2&&(controlTextKeyfigure.innerHTML="<b>-2-</b>"),controlUIKeyfigure.appendChild(controlTextKeyfigure),google.maps.event.addDomListener(controlUIKeyfigure,"click",function(){if(that.runtimedata().dimensions[0].members.length>1)if(controlUIKeyfigure.figure1===!0&&""!==saveKeyFigureName2){controlUIKeyfigure.figure1=!1,controlUIKeyfigure.figure2=!0,controlTextKeyfigure.innerHTML="<b>-2-</b>",controlTextKeyfigure.style.color="green";for(var i=0;i<that.markerClusterer.markers_.length;i++)that.markerClusterer.markers_[i].labelContent=that.markerClusterer.markers_[i].keyfigure2,that.markerClusterer.markers_[i].activeKeyfigure=1;that.keyfiguretodisplay(saveKeyFigureName2),that.firePropertiesChanged(["keyfiguretodisplay"]),that.markerClusterer.repaint()}else if(controlUIKeyfigure.figure1===!1){controlUIKeyfigure.figure1=!0,controlUIKeyfigure.figure2=!1,controlTextKeyfigure.innerHTML="<b>-1-</b>",controlTextKeyfigure.style.color="black";for(var i=0;i<that.markerClusterer.markers_.length;i++)that.markerClusterer.markers_[i].labelContent=that.markerClusterer.markers_[i].keyfigure1,that.markerClusterer.markers_[i].activeKeyfigure=0;that.keyfiguretodisplay(saveKeyFigureName1),that.firePropertiesChanged(["keyfiguretodisplay"]),that.markerClusterer.repaint()}})}function MapsMarkerDisplayControl(controlDiv){controlDiv.style.padding="5px";var controlUIMarkerDisplay=document.createElement("div");controlUIMarkerDisplay.style.backgroundColor="white",controlUIMarkerDisplay.style.borderColor="grey",controlUIMarkerDisplay.style.borderStyle="solid",controlUIMarkerDisplay.style.borderWidth="1px",controlUIMarkerDisplay.style.cursor="pointer",controlUIMarkerDisplay.style.textAlign="center",controlUIMarkerDisplay.title="Click to show all markers again",controlDiv.appendChild(controlUIMarkerDisplay);var controlTextMarkerDisplay=document.createElement("div");controlTextMarkerDisplay.style.fontFamily="Arial,sans-serif",controlTextMarkerDisplay.style.fontSize="9px",controlTextMarkerDisplay.style.fontWeight="normal",controlTextMarkerDisplay.style.color="black",controlTextMarkerDisplay.style.paddingTop="2px",controlTextMarkerDisplay.style.paddingLeft="5px",controlTextMarkerDisplay.style.paddingRight="5px",controlTextMarkerDisplay.style.paddingBottom="2px",controlTextMarkerDisplay.innerHTML="<b>Show all markers</b>",controlUIMarkerDisplay.appendChild(controlTextMarkerDisplay),google.maps.event.addDomListener(controlUIMarkerDisplay,"click",function(){showAllMarkers(),that.markerClusterer.repaint()})}function MapsLayerControl(controlDiv){controlDiv.style.padding="5px";var controlUITraffic=document.createElement("div");controlUITraffic.style.backgroundColor="white",controlUITraffic.style.borderColor="grey",controlUITraffic.style.borderStyle="solid",controlUITraffic.style.borderWidth="1px",controlUITraffic.style.cursor="pointer",controlUITraffic.style.textAlign="center",controlUITraffic.title="Click to activate traffic layer",controlUITraffic.active=!1,controlDiv.appendChild(controlUITraffic);var controlTextTraffic=document.createElement("div");controlTextTraffic.style.fontFamily="Arial,sans-serif",controlTextTraffic.style.fontSize="9px",controlTextTraffic.style.fontWeight="normal",controlTextTraffic.style.color="grey",controlTextTraffic.style.paddingTop="2px",controlTextTraffic.style.paddingLeft="5px",controlTextTraffic.style.paddingRight="5px",controlTextTraffic.style.paddingBottom="2px",controlTextTraffic.innerHTML="<b>Traffic</b>",controlUITraffic.appendChild(controlTextTraffic);var controlUIWeather=document.createElement("div");controlUIWeather.style.backgroundColor="white",controlUIWeather.style.borderColor="grey",controlUIWeather.style.borderStyle="solid",controlUIWeather.style.borderWidth="1px",controlUIWeather.style.cursor="pointer",controlUIWeather.style.textAlign="center",controlUIWeather.title="Click to activate weather layer",controlUIWeather.active=!1,controlDiv.appendChild(controlUIWeather);var controlTextWeather=document.createElement("div");controlTextWeather.style.fontFamily="Arial,sans-serif",controlTextWeather.style.fontSize="9px",controlTextWeather.style.fontWeight="normal",controlTextWeather.style.color="grey",controlTextWeather.style.paddingTop="2px",controlTextWeather.style.paddingLeft="5px",controlTextWeather.style.paddingRight="5px",controlTextWeather.style.paddingBottom="2px",controlTextWeather.innerHTML="<b>Weather</b>",controlUIWeather.appendChild(controlTextWeather),google.maps.event.addDomListener(controlUITraffic,"click",function(){controlUITraffic.active===!0?(controlUITraffic.active=!1,that.trafficLayer.setMap(null)):(controlUITraffic.active=!0,that.trafficLayer.setMap(that.map))}),google.maps.event.addDomListener(controlUIWeather,"click",function(){controlUIWeather.active===!0?(controlUIWeather.active=!1,that.weatherLayer.setMap(null),that.cloudLayer.setMap(null)):(controlUIWeather.active=!0,that.weatherLayer.setMap(that.map),that.cloudLayer.setMap(that.map))})}var DB_URL=null,DB_URL_EXTENSION=null,OBJECT_STORE=null,STORE_NAME="addresses",DB=null,DB_NAME="convista_maps_addresses",ALL_ADDRESSES=null,IMAGE_URL="",BASE_URL="",MARKERLABEL_INCLUDE="markerwithlabel_packed.js",MARKERCLUSTER_INCLUDE="markerclusterer_packed.js",OMS_INCLUDE="oms.min.js",DEFAULT_LATITUDE=50.938405,DEFAULT_LONGITUDE=6.953648,meta_data=null,runtime_data=null,saveAddressDimension=null,saveTextDimension=null,saveKeyFigureName1=null,saveKeyFigureName2=null,saveKeyFigureName1ClusterSteps=null,saveKeyFigureName2ClusterSteps=null,saveDateDimension=null,saveAPIKey=null,saveApiLoad=null,addressData=null,clusterSelectionData=null,addressSelectionData=null,dateSelectionData=null,idSelectionData=null,keyFigureToDisplayData=null,that=this,initialize=!0,keyfigureFormatStrings=[];this.init=function(){scriptSrc&&(BASE_URL=scriptSrc.substring(0,scriptSrc.indexOf("js/")),IMAGE_URL=BASE_URL+"images/m",BASE_URL+="js/"),ALL_ADDRESSES=[]},this.beforeUpdate=function(){},this.afterUpdate=function(){if(null!==runtime_data&&runtime_data.changed===!0&&initialize===!1){runtime_data.changed=!1;for(var notif_position_in_dimensions_array=0,iter_step=0,l=0;l<runtime_data.dimensions.length;l++)dim=runtime_data.dimensions[l],dim.containsMeasures===!0?iter_step=dim.members.length:dim.key===saveTextDimension&&(notif_position_in_dimensions_array=l);for(var tuples_grouped_by_rowKey=[],i=0,current_row_key_index=runtime_data.tuples[0][notif_position_in_dimensions_array],current_tuples_to_group=new Array;i<runtime_data.tuples.length;){var tuple=runtime_data.tuples[i];if(tuple[notif_position_in_dimensions_array]===current_row_key_index){var row=runtime_data.dimensions[1].members[tuple[1]].type;"RESULT"!==row&&current_tuples_to_group.push(tuple)}else tuples_grouped_by_rowKey.push(current_tuples_to_group),current_tuples_to_group=new Array,current_tuples_to_group.push(tuple),current_row_key_index=tuple[notif_position_in_dimensions_array];i===runtime_data.tuples.length-1&&tuples_grouped_by_rowKey.push(current_tuples_to_group),i++}var dim=null,address=null,marker_text=null,date=null,id_array=[],address_array=[],text_array=[],date_array=[],keyfigure_updated=[],keyfigure2_array=[],keyfigure2=0,keyfigure1_array=[],keyfigure1=0,keyfigure2_array_diff=[],keyfigure2_diff=0,keyfigure1_array_diff=[],keyfigure1_diff=0,data_pointer=-iter_step;if(tuples_grouped_by_rowKey){for(var l=0;l<tuples_grouped_by_rowKey.length;l++){for(var id=0,i=0;i<tuples_grouped_by_rowKey[l].length;i+=iter_step){var tuple=tuples_grouped_by_rowKey[l][i];data_pointer+=iter_step;for(var j=0;j<tuple.length;j++)if(dim=runtime_data.dimensions[j],dim.key===saveTextDimension&&(id=dim.members[tuple[j]].key,marker_text=dim.members[tuple[j]].text),dim.key===saveAddressDimension)address=dim.members[tuple[j]].text;else if(dim.key===saveDateDimension)date=dim.members[tuple[j]].text;else if(dim.containsMeasures===!0)for(var k=0;k<dim.members.length;k++){var index=data_pointer+k,data_init="";dim.members[k].text===saveKeyFigureName1?null===runtime_data.data[index]||""===runtime_data.data[index]?(data_init=isFloat(keyfigureFormatStrings.figure1)?parseFloat("0.00").toFixed(4):"0",keyfigure1_array.push(data_init)):keyfigure1_array.push(runtime_data.data[index]):dim.members[k].text===saveKeyFigureName2?null===runtime_data.data[index]||""===runtime_data.data[index]?(data_init=isFloat(keyfigureFormatStrings.figure2)?parseFloat("0.00").toFixed(4):"0",keyfigure2_array.push(data_init)):keyfigure2_array.push(runtime_data.data[index]):dim.members[k].text===saveKeyFigureName1Diff?null===runtime_data.data[index]||""===runtime_data.data[index]?(data_init=isFloat(keyfigureFormatStrings.figure1)?parseFloat("0.00").toFixed(4):"0",keyfigure1_array_diff.push(data_init)):keyfigure1_array_diff.push(runtime_data.data[index]):dim.members[k].text===saveKeyFigureName2Diff&&(null===runtime_data.data[index]||""===runtime_data.data[index]?(data_init=isFloat(keyfigureFormatStrings.figure2)?parseFloat("0.00").toFixed(4):"0",keyfigure2_array_diff.push(data_init)):keyfigure2_array_diff.push(runtime_data.data[index]))}}id_array.push(id),address_array.push(address),text_array.push(marker_text),date_array.push(date);for(var m=0;m<keyfigure1_array.length;m++)isInt(keyfigureFormatStrings.figure1)?(keyfigure1+=parseInt(keyfigure1_array[m],10),keyfigure1_diff+=parseInt(keyfigure1_array_diff[m],10)):(keyfigure1+=parseFloat(keyfigure1_array[m]),keyfigure1_diff+=parseFloat(keyfigure1_array_diff[m])),isInt(keyfigureFormatStrings.figure2)?(keyfigure2+=parseInt(keyfigure2_array[m],10),keyfigure2_diff+=parseInt(keyfigure2_array_diff[m],10)):(keyfigure2+=parseFloat(keyfigure2_array[m]),keyfigure2_diff+=parseFloat(keyfigure2_array_diff[m]));keyfigure_updated[l]=[keyfigure1,keyfigure2,keyfigure1_diff,keyfigure2_diff],keyfigure1_array=[],keyfigure2_array=[],keyfigure1_array_diff=[],keyfigure2_array_diff=[],keyfigure1=0,keyfigure2=0,keyfigure1_diff=0,keyfigure2_diff=0}hideMarkers();for(var i=0;i<id_array.length;i++){var marker_updated=markClusterToShowById(id_array[i],keyfigure_updated[i]);if(marker_updated===!1){var doc=findInAddressDatabase(address_array[i]);if(null!==doc&&void 0!==doc){var loc=new google.maps.LatLng(doc.geometry.coordinates[0],doc.geometry.coordinates[1]);createMarker(address_array[i],keyfigure_updated[i],text_array[i],loc,date_array[i],id_array[i])}}}this.markerClusterer.repaint(),keyfigure_updated=[],id_array=[]}else alert("Chosen dataset is empty.")}initialize===!0&&(null!==DB_URL&&void 0!==DB_URL&&""!==DB_URL?($.ajax({type:"GET",url:DB_URL+DB_URL_EXTENSION,async:!1,contentType:"application/json",success:function(json){for(var rows=JSON.parse(json).rows,i=0;i<rows.length;i++)ALL_ADDRESSES.push(rows[i].doc)},error:function(e){window.console&&console.log(e.statusText)}}),initMap(function(){initData()}),initialize=!1):(openAddressDatabase(function(){getAllItems(function(){initMap(function(){initData()})})}),initialize=!1))},this.componentDeleted=function(){},this.metadata=function(value){return void 0===value?meta_data:(meta_data=value,this)},this.runtimedata=function(value){return void 0===value?runtime_data:(null!==runtime_data&&""!==runtime_data&&void 0!==runtime_data.tuples&&void 0!==value.tuples&&runtime_data.tuples.length!==value.tuples.length?(runtime_data=value,runtime_data.changed=!0):(runtime_data=value,runtime_data.changed=!1),this)},this.apikey=function(value){return void 0===value?saveAPIKey:(saveAPIKey=value,this)},this.databaseaddress=function(value){return void 0===value?DB_URL:(DB_URL=value,this)},this.databaseaddressextension=function(value){return void 0===value?DB_URL_EXTENSION:(DB_URL_EXTENSION=value,this)},this.address=function(value){return void 0===value?addressData:(addressData=value,this)},this.clusterselection=function(value){return void 0===value?clusterSelectionData:(clusterSelectionData=value,this)},this.addressselection=function(value){return void 0===value?addressSelectionData:(addressSelectionData=value,this)},this.dateselection=function(value){return void 0===value?dateSelectionData:(dateSelectionData=value,this)},this.idselection=function(value){return void 0===value?idSelectionData:(idSelectionData=value,this)},this.addressdimension=function(value){return void 0===value?saveAddressDimension:(saveAddressDimension=value,this)},this.textdimension=function(value){return void 0===value?saveTextDimension:(saveTextDimension=value,this)},this.datedimension=function(value){return void 0===value?saveDateDimension:(saveDateDimension=value,this)},this.keyfigurename1=function(value){return void 0===value?saveKeyFigureName1:(saveKeyFigureName1=value,this)},this.keyfigurename1diff=function(value){return void 0===value?saveKeyFigureName1Diff:(saveKeyFigureName1Diff=value,this)},this.keyfigurename1clustersteps=function(value){if(void 0===value)return saveKeyFigureName1ClusterSteps;try{saveKeyFigureName1ClusterSteps=JSON.parse(value)}catch(e){window.console&&console.log("invalid json for cluster steps for keyfigure1 :"+value)}return this},this.keyfigurename2=function(value){return void 0===value?saveKeyFigureName2:(saveKeyFigureName2=value,this)},this.keyfigurename2diff=function(value){return void 0===value?saveKeyFigureName2Diff:(saveKeyFigureName2Diff=value,this)},this.keyfigurename2clustersteps=function(value){if(void 0===value)return saveKeyFigureName2ClusterSteps;try{saveKeyFigureName2ClusterSteps=JSON.parse(value)}catch(e){window.console&&console.log("invalid json for cluster steps for keyfigure2 : "+value)}return this},this.keyfiguretolerance=function(value){return void 0===value?saveKeyFigureTolerance:(isFloat(value)?saveKeyFigureTolerance=value:isInt(value)?saveKeyFigureTolerance=value/100:window.console&&console.log("Wrong or missing input for keyfigure tolerance! "+value),this)},this.keyfiguretodisplay=function(value){if(void 0===value||""===value)return keyFigureToDisplayData;if(keyFigureToDisplayData!==value&&null!==keyFigureToDisplayData&&""!==keyFigureToDisplayData){if(value===that.keyfigurename1())for(var i=0;i<that.markerClusterer.markers_.length;i++)that.markerClusterer.markers_[i].labelContent=that.markerClusterer.markers_[i].keyfigure1,that.markerClusterer.markers_[i].activeKeyfigure=0;else if(value===that.keyfigurename2())for(var i=0;i<that.markerClusterer.markers_.length;i++)that.markerClusterer.markers_[i].labelContent=that.markerClusterer.markers_[i].keyfigure2,that.markerClusterer.markers_[i].activeKeyfigure=1;that.markerClusterer.repaint()}return keyFigureToDisplayData=value,this},this.apiload=function(value){return void 0===value?saveApiLoad:void(saveApiLoad=value)
}})}();