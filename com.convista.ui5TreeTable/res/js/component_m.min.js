/* 
 * @version 1.0
 * @copyright ConVista
 * @author Martin Pankraz
 *
 * @classdesc UI5 HIerarchy Selector Plugin for SAP Design Studio in m mode
 *
 *
 * This component makes use of the jQuery Plugin waituntilExists by buu700 under the MIT License
 */
var libPathTreeTable=sap.zen.createStaticSdkMimeUrl("com.convista.ui5treetable","res/js/");require.config({paths:{exist:"../"+libPathTreeTable+"jquery.waituntilexists"},rlArgs:"v=20140515"}),define(["exist","css!../js/css/myUI5TreeTable.css"],function(){var that=null;jQuery.sap.require("sap.zen.commons.layout.AbsoluteLayout"),jQuery.sap.require("sap.ui.table.TreeTable"),sap.zen.commons.layout.AbsoluteLayout.extend("com.convista.ui5treetable.UI5HierarchySelector",{setData:function(value){return this._data=value,this},getData:function(){return this._data},setMetadata:function(value){return this._metadata=value,this},getMetadata:function(){return this._metadata},metadata:{properties:{DTableTitle:{type:"string"},DDimensionKey:{type:"string"},DHierarchyKey:{type:"string"},DHierarchyText:{type:"string"},DCheckBoxSelection:{type:"string"},DCheckBoxSelectionExt:{type:"string"},DCheckBoxSelectionFull:{type:"string"},DCheckBoxSelectionMixed:{type:"string"},DFilterSelectionExt:{type:"string"},DVisibleRowCount:{type:"int"},DExpandAllLevel:{type:"int"},DExpandFirstLevel:{type:"boolean"},DVisibleRowCountMode:{type:"String"},DRowHeight:{type:"int"},DShowRowLines:{type:"boolean"},DHideKeyOnKeyTextDisplay:{type:"boolean"},DExpandText:{type:"string"},DCollapseText:{type:"string"},DSelectedText:{type:"string"}}},initDesignStudio:function(){sap.m.CheckBox.extend("com.convista.TriStateCheckBox",{metadata:{properties:{state:{type:"int",defaultValue:0}}},onAfterRendering:function(){var $this=this.$();$this.find("div").removeClass("sapMCbMarkChecked"),$this.removeClass("triStateCheckBoxSelected"),$this.removeClass("triStateCheckBoxMixed"),1===this.getState()?$this.addClass("triStateCheckBoxSelected"):2===this.getState()&&$this.addClass("triStateCheckBoxMixed")},fireSelect:function(s){var v=s.selected?1:0;0===this.getState()&&1===v?v=1:1===this.getState()&&1===v&&(v=0),this.setState(v),this.fireEvent("select",{state:v})},renderer:{}}),that=this,this.sCurrentLocale=sap.ui.getCore().getConfiguration().getLanguage(),this.myBundle=jQuery.sap.resources({url:libPathTreeTable+"i18n/i18n.properties",locale:this.sCurrentLocale}),this.addStyleClass("myUI5Table-auto-size"),this.tableContentHidden=!0,this.tableContentCreated=!1,this._hierarchy=null,this._hierarchy_selection=[],this._hierarchy_selection_ext=[],this._hierarchy_filter_ext=[],this._hierarchy_selection_full_key=[],this._hierarchy_mixed=[],this._selectionCounter=0,this._expandLevel=1,that._counterLabel=new sap.m.Label({text:"0 selected",tooltip:this.myBundle.getText("counterLabel"),textAlign:"Right"}).addStyleClass("treeTableLabelM"),that._uncollapseAllBtn=new sap.m.Button({type:sap.m.ButtonType.Transparent,icon:"sap-icon://process",tooltip:this.myBundle.getText("expandAllButtonTooltip"),lite:!0,visible:!1,press:function(){that._expandLevel>0&&that._table.expandToLevel(that._expandLevel)}}).addStyleClass("treeTableButtonRightM"),that._collapseButton=new sap.m.Button({type:sap.m.ButtonType.Transparent,text:"uncollapse",tooltip:this.myBundle.getText("collapseButtonTooltip"),icon:"sap-icon://slim-arrow-right",press:function(){that._table.getVisible()?(that._table.setVisible(!1),this.setIcon("sap-icon://slim-arrow-right"),this.setText(that.getDExpandText()),that._uncollapseAllBtn.setVisible(!1)):(that._table.setVisible(!0),this.setIcon("sap-icon://slim-arrow-down"),this.setText(that.getDCollapseText()),that._uncollapseAllBtn.setVisible(!0))}}).addStyleClass("convistaCollapseButtonM"),that._table=new sap.ui.table.TreeTable(this.getId()+"_trta",{visibleRowCount:12,rowHeight:22,firstVisibleRow:1,selectionMode:sap.ui.table.SelectionMode.None,expandFirstLevel:!0,allowColumnReordering:!1,showOverlay:!1,visible:!1}).addStyleClass("convistaTreeTable"),this.clickHandlerActive=!1,this.attachBrowserEvent("focusin",function(){that.clickHandlerActive||($(document).on("click",function(e){var target=e.target,container=$("#"+that.getId()+"_trta"),uncollapseAllBtnId=that._uncollapseAllBtn.getId(),collapseBtnId=that._collapseButton.getId();-1===e.target.id.indexOf(uncollapseAllBtnId)&&-1===e.target.id.indexOf(collapseBtnId)&&(container.is(target)||0!==container.has(target).length||(that._table.setVisible(!1),that._collapseButton.setIcon("sap-icon://slim-arrow-right"),that._uncollapseAllBtn.setVisible(!1),that._collapseButton.setText(that.getDExpandText()),that.fireDesignStudioEvent("onFocusOut"),$(document).off("click"),that.clickHandlerActive=!1))}),that.clickHandlerActive=!0)}),this._oModel=new sap.ui.model.json.JSONModel,sap.ui.getCore().setModel(this._oModel),this._table.setModel(this._oModel),this._toolbar=new sap.m.Toolbar({content:[new sap.ui.layout.HorizontalLayout({width:"100%",content:[that._collapseButton,that._counterLabel,that._uncollapseAllBtn]})]}).addStyleClass("convistaTreeToolbar"),this.addContent(that._toolbar,{left:"0px",top:"0px"}),this.addContent(that._table,{left:"0px",top:"30px"}),this.layoutInitialized=!1,this.reloadRequested=!0,this._table.attachCellClick(that.onCellClick),this._table.attachRowSelectionChange(that.onRowClick),this._table.attachToggleOpenState(that.onToggleClick)},renderer:{},onAfterRendering:function(){},afterDesignStudioUpdate:function(){that=this;if(!that.layoutInitialized){that._counterLabel.setText("0 "+this.getDSelectedText()),that._collapseButton.setText(this.getDExpandText()),that._table.setVisibleRowCount(this.getDVisibleRowCount()),that._table.setVisibleRowCountMode("Auto"===this.getDVisibleRowCountMode()?sap.ui.table.VisibleRowCountMode.Auto:"Fixed"===this.getDVisibleRowCountMode()?sap.ui.table.VisibleRowCountMode.Fixed:sap.ui.table.VisibleRowCountMode.Interactive),that._table.setRowHeight(this.getDRowHeight()),that._table.setExpandFirstLevel(this.getDExpandFirstLevel()),this.getDShowRowLines()||that._table.addStyleClass("treeTableNoRowLines"),that._expandLevel=this.getDExpandAllLevel(),that.layoutInitialized=!0;var dimText="Hierarchy",_data=this.getData();if(void 0!==_data.dimensions)for(var i=0;i<_data.dimensions.length;i++)_data.dimensions[i].key===this.getDDimensionKey()&&(dimText=_data.dimensions[i].text);var oColumn=new sap.ui.table.Column({resizable:!1,flexible:!1,autoResizable:!1,width:"300px",label:new sap.m.Label({text:dimText,design:sap.m.LabelDesign.Bold}),template:new com.convista.TriStateCheckBox({text:"{text}",state:"{checked}",select:function(e){that.onCheckBoxChange(e)}}).addStyleClass("myTriCb")});that._table.addColumn(oColumn);var data={root:{children:that.flattenFormattedData()}};that._oModel.setData(data),that._table.setModel(that._oModel),that._table.bindRows("/root"),this.tableContentCreated=!0}},onCellClick:function(){},onRowClick:function(){},onToggleClick:function(){},onCheckBoxChange:function(oEvent){var me=oEvent.getSource(),state=me.getState(),path=(me.getBindingContext(),me.getBindingContext().getPath()),obj=that._table.getModel().getProperty(path);1===state?that.addHierarchySelection(obj):0===state&&that.removeHierarchySelection(obj),that.updateStateOfChildren(obj,path,state),void 0!==obj.level&&that.updateStateOfParent(path,state);var keysBexReady="",keysBexReadyExt="",keysFullBexReady="",mixedSelction="",filterExtBexReady="";this._hierarchy_selection.length>0&&(keysBexReady=JSON.stringify(this._hierarchy_selection),keysBexReadyExt=JSON.stringify(this._hierarchy_selection_ext),keysFullBexReady=JSON.stringify(this._hierarchy_selection_full_key),filterExtBexReady=JSON.stringify(this._hierarchy_filter_ext),keysBexReady=keysBexReady.substring(2,keysBexReady.length-2),keysBexReadyExt=keysBexReadyExt.substring(2,keysBexReadyExt.length-2),keysFullBexReady=keysFullBexReady.substring(2,keysFullBexReady.length-2),filterExtBexReady=filterExtBexReady.substring(2,filterExtBexReady.length-2),keysBexReady=that.replaceAll(keysBexReady,",",";"),keysBexReadyExt=that.replaceAll(keysBexReadyExt,",",";"),keysFullBexReady=that.replaceAll(keysFullBexReady,",",";"),filterExtBexReady=that.replaceAll(filterExtBexReady,",",";"),keysBexReady=that.replaceAll(keysBexReady,'"',""),keysBexReadyExt=that.replaceAll(keysBexReadyExt,'"',""),keysFullBexReady=that.replaceAll(keysFullBexReady,'"',""),filterExtBexReady=that.replaceAll(filterExtBexReady,'"',""),mixedSelction=JSON.stringify(this._hierarchy_mixed),mixedSelction=mixedSelction.substring(2,mixedSelction.length-2),mixedSelction=that.replaceAll(mixedSelction,",",";"),mixedSelction=that.replaceAll(mixedSelction,'"',"")),that.setDCheckBoxSelection(keysBexReady),that.setDCheckBoxSelectionExt(keysBexReadyExt),that.setDCheckBoxSelectionFull(keysFullBexReady),that.setDCheckBoxSelectionMixed(mixedSelction),that.setDFilterSelectionExt(filterExtBexReady),that.fireDesignStudioPropertiesChanged(["DCheckBoxSelection","DCheckBoxSelectionExt","DFilterSelectionExt","DCheckBoxSelectionFull","DCheckBoxSelectionMixed"]),that.fireDesignStudioEvent("onCheckBoxSelected")},updateStateOfChildren:function(obj,parentPath,state){if("HIERARCHY_NODE"===obj.type)for(var pathToChildren=parentPath+"/children",obj_children=that._table.getModel().getProperty(pathToChildren),i=0;i<obj_children.length;i++){var child=obj_children[i];child.checked=state,1===state?that.addHierarchySelection(child):0===state?that.removeHierarchySelection(child):2===state&&that.removeHierarchySelection(child),child.children.length>0&&that.updateStateOfChildren(child,pathToChildren+"/"+i,child.checked)}},updateStateOfParent:function(currentPath,state){var countChecked=0,countMixed=0,newState=0,parentPath=currentPath.substring(0,currentPath.lastIndexOf("/children")),parentObj=that._table.getModel().getProperty(parentPath);that.removeHierarchySelection(parentObj);var numberOfChildren=parentObj.children.length;if(numberOfChildren>0){for(var i=0;numberOfChildren>i;i++){var child=parentObj.children[i];1===child.checked?countChecked++:2===child.checked&&countMixed++}0===countChecked?(newState=0,that.removeMixedSelection(parentObj)):numberOfChildren>countChecked&&(newState=2,that.addMixedSelection(parentObj)),0!==countMixed&&(newState=2,that.addMixedSelection(parentObj)),parentObj.checked=newState,void 0!==parentObj.level&&that.updateStateOfParent(parentPath,newState)}else parentObj.children.checked=state},addHierarchySelection:function(obj){var compareKey=null,compareKeyExt=null,compareKeyFull=null;void 0!==obj.key?(compareKey=obj.key.substring(obj.key.lastIndexOf("/")+1),compareKeyExt=that.extractFromKeyText(obj.text,compareKey),compareKeyFull=obj.key):(compareKey=obj.children.key.substring(obj.children.key.lastIndexOf("/")+1),compareKeyExt=that.extractFromKeyText(obj.children.text,compareKey),compareKeyFull=obj.children.key);var idx=$.inArray(compareKey,this._hierarchy_selection);-1===idx&&(this._hierarchy_selection.push(compareKey),this._hierarchy_selection_ext.push(compareKeyExt),this._hierarchy_selection_full_key.push(compareKeyFull),this._hierarchy_filter_ext.push(obj.filterExtValue),that._selectionCounter++,that._counterLabel.setText(that._selectionCounter+" "+this.getDSelectedText()))},removeHierarchySelection:function(obj){var compareKey=null;compareKey=void 0!==obj.key?obj.key.substring(obj.key.lastIndexOf("/")+1):obj.children.key.substring(obj.children.key.lastIndexOf("/")+1);var idx=$.inArray(compareKey,this._hierarchy_selection);-1!==idx&&(this._hierarchy_selection.splice(idx,1),this._hierarchy_selection_ext.splice(idx,1),this._hierarchy_selection_full_key.splice(idx,1),this._hierarchy_filter_ext.splice(idx,1),that._selectionCounter--,that._counterLabel.setText(that._selectionCounter+" "+this.getDSelectedText()))},addMixedSelection:function(obj){var compareKey=null,compareKeyFull=null;void 0!==obj.key?(compareKey=obj.key.substring(obj.key.lastIndexOf("/")+1),compareKeyFull=obj.key):(compareKey=obj.children.key.substring(obj.children.key.lastIndexOf("/")+1),compareKeyFull=obj.children.key);var idx=$.inArray(compareKey,this._hierarchy_mixed);-1===idx&&this._hierarchy_mixed.push(compareKey)},removeMixedSelection:function(obj){var compareKey=null;compareKey=void 0!==obj.key?obj.key.substring(obj.key.lastIndexOf("/")+1):obj.children.key.substring(obj.children.key.lastIndexOf("/")+1);var idx=$.inArray(compareKey,this._hierarchy_mixed);-1!==idx&&this._hierarchy_mixed.splice(idx,1)},flattenFormattedData:function(){var result=[],isInDesignMode=void 0!==sap.zen.designmode;if(isInDesignMode)return this.getExampleData();var _data=this.getData();if(void 0!==_data.dimensions)for(var i=0;i<_data.dimensions.length;i++)if(_data.dimensions[i].key===this.getDDimensionKey()){var members=_data.dimensions[i].members;if(members.length>0){if(this.setDHierarchyKey(_data.dimensions[i].hierarchy.key),this.setDHierarchyText(_data.dimensions[i].hierarchy.text),that.fireDesignStudioPropertiesChanged(["DHierarchyKey","DHierarchyText"]),this._hierarchy=members[0],this.getDHideKeyOnKeyTextDisplay()&&(this._hierarchy.text=that.extractFromKeyText(members[0].text,members[0].key)),"HIERARCHY_NODE"===this._hierarchy.type){var hier_parts=this._hierarchy.key.split("/"),hier_characteristic=hier_parts[1],shortKey=this._hierarchy.key.substring(this._hierarchy.key.lastIndexOf("/")+1);this._hierarchy.filterExtValue="0HIER_NODE"===hier_characteristic?"+"+shortKey+"(Text Node)":"+"+shortKey+"("+hier_characteristic+")"}else this._hierarchy.filterExtValue=this._hierarchy.key.substring(this._hierarchy.key.lastIndexOf("/")+1);this._hierarchy.children=[];var wasChecked=that.entryWasChecked(members[0].key);return 0===wasChecked?(this._hierarchy.checked=0,that.removeHierarchySelection(this._hierarchy)):1===wasChecked?(this._hierarchy.checked=1,that.addHierarchySelection(this._hierarchy)):2===wasChecked&&(this._hierarchy.checked=2,that.addMixedSelection(this._hierarchy)),this.resolveHierarchy(members.slice(1),this._hierarchy.children,members[0].key),this._hierarchy}}return result},resolveHierarchy:function(data,parentChildren,parentKey){for(var i=0;i<data.length;i++){var entry=data[i],wasChecked=that.entryWasChecked(entry.key);if(0===wasChecked?(entry.checked=0,that.removeHierarchySelection(entry)):1===wasChecked?(entry.checked=1,that.addHierarchySelection(entry)):2===wasChecked&&(entry.checked=2,that.addMixedSelection(entry)),this.getDHideKeyOnKeyTextDisplay()&&(entry.text=that.extractFromKeyText(entry.text,entry.key)),"HIERARCHY_NODE"===entry.type){var hier_parts=entry.key.split("/"),hier_characteristic=hier_parts[1],shortKey=entry.key.substring(entry.key.lastIndexOf("/")+1);entry.filterExtValue="0HIER_NODE"===hier_characteristic?"+"+shortKey+"(Text Node)":"+"+shortKey+"("+hier_characteristic+")"}else entry.filterExtValue=entry.key;entry.parent===parentKey&&(entry.children=[],parentChildren.push(entry),void 0!==entry.type&&that.resolveHierarchy(data.slice(1),entry.children,entry.key))}},entryWasChecked:function(entry){var result=0,formerSelection=that.getDCheckBoxSelection();formerSelection=formerSelection.split(";");var compareKey=entry.substring(entry.lastIndexOf("/")+1),idx=$.inArray(compareKey,formerSelection);if(-1===idx){var formerMixedSelection=that.getDCheckBoxSelectionMixed();formerMixedSelection=formerMixedSelection.split(";");var idx=$.inArray(compareKey,formerMixedSelection);result=-1===idx?0:2}else result=1;return result},extractFromKeyText:function(text,internalKey){var result=internalKey;internalKey=internalKey.substring(internalKey.lastIndexOf("/")+1);for(var parts=text.split("|"),i=0;i<parts.length;i++){var part=parts[i].replace("/","");if(-1!==part.indexOf(internalKey)){result=parts[i];break}}return result},getExampleData:function(){var oData={text:"root",description:"root description",checked:0,children:[{text:"item1",description:"item1 description",checked:1,children:[{text:"subitem1-1",description:"subitem1-1 description",checked:2,children:[{text:"subsubitem1-1-1",description:"subsubitem1-1-1 description",checked:0},{text:"subsubitem1-1-2",description:"subsubitem1-1-2 description",checked:1}]},{text:"subitem1-2",description:"subitem1-2 description",checked:1,children:[{text:"subsubitem1-2-1",description:"subsubitem1-2-1 description",checked:1}]}]},{text:"item2",description:"item2 description",checked:1,children:[{text:"subitem2-1",description:"subitem2-1 description",checked:1}]},{text:"item3",description:"item3 description",checked:1}]};return oData},compareIntegers:function(value1,value2){return null!=value1&&void 0!=value1&&""!=value1||null!=value2&&void 0!=value2&&""!=value2?null==value1||void 0==value1||""==value1?-1:null==value2||void 0==value2||""==value2?1:parseInt(value1)<parseInt(value2)?-1:parseInt(value1)==parseInt(value2)?0:parseInt(value1)>parseInt(value2)?1:void 0:0},compareFloats:function(value1,value2){return null!=value1&&void 0!=value1&&""!=value1||null!=value2&&void 0!=value2&&""!=value2?null==value1||void 0==value1||""==value1?-1:null==value2||void 0==value2||""==value2?1:parseFloat(value1)<parseFloat(value2)?-1:parseFloat(value1)==parseFloat(value2)?0:parseFloat(value1)>parseFloat(value2)?1:void 0:0},compareDates:function(value1,value2){return null!=value1&&void 0!=value1&&""!=value1||null!=value2&&void 0!=value2&&""!=value2?null==value1||void 0==value1||""==value1?-1:null==value2||void 0==value2||""==value2?1:(value1=that.parseDateString(value1),value2=that.parseDateString(value2),value2>value1?-1:value1>value2?1:0):0},compareText:function(value1,value2){return value1.toLowerCase(),value2.toLowerCase(),value1.localeCompare(value2)},isInteger:function(value){var regex=/^\d+|"\d+"$/;return regex.test(value)},isFloat:function(value){var regex=/^\d+\.\d+|"\d+\.\d+"$/;return regex.test(value)},isDate:function(value){var result=null,regex=/^[0-9]{2}(\.|-|\/)[0-9]{2}(\.|-|\/)[0-9]{4}(\s*[0-9]{2}:[0-9]{2}:[0-9]{2})?(\s(AM|PM))?$/;return result=regex.test(value)?!0:!1},parseDateString:function(value){var splitter=null,year="",month="",day="",time="",hasTime=!1,parts="";return-1!==value.indexOf(":")&&(hasTime=!0),-1!==value.indexOf("/")?(splitter="/",parts=value.split(splitter),year=parts[2],hasTime&&(year=parts[2].replace(/\s{2,}/g," ").split(" "),time=year[1].split(":"),year=year[0]),month=parts[0]-1,day=parts[1]):-1!==value.indexOf(".")?(splitter=".",parts=value.split(splitter),year=parts[2],hasTime&&(year=parts[2].replace(/\s{2,}/g," ").split(" "),time=year[1].split(":"),year=year[0]),month=parts[1]-1,day=parts[0]):-1!==value.indexOf("-")?(splitter="-",parts=value.split(splitter),year=parts[2],hasTime&&(year=parts[2].replace(/\s{2,}/g," ").split(" "),time=year[1].split(":"),year=year[0]),month=parts[0]-1,day=parts[1]):window.console&&console.log("parseDateString: not a date! "+value),hasTime?(("PM"===value.slice(-2)||"pm"===value.slice(-2))&&(time[0]=parseInt(time[0])+12),new Date(year,month,day,time[0],time[1],time[2])):new Date(year,month,day)},checkIE:function(){var ms_ie=!1,ua=window.navigator.userAgent,old_ie=ua.indexOf("MSIE "),new_ie=ua.indexOf("Trident/");return(old_ie>-1||new_ie>-1)&&(ms_ie=!0),ms_ie},checkFF:function(){return navigator.userAgent.toLowerCase().indexOf("firefox")>-1?!0:!1},replaceAll:function(string,find,replace){return string.replace(new RegExp(this.escapeRegExp(find),"g"),replace)},escapeRegExp:function(string){return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")}})});